if [[ $OSTYPE != *"darwin"* || ! -n "$ITERM_SESSION_ID" ]]; then
    echo "Error: Not MacOS or not using iTerm. Exiting" >&2
    return 1
fi

if [[ -n $PROJECT_WINDOW_NUM ]] ; then
    precommands=(\
        " export PROJECT_NAME=$PROJECT_NAME" \
        " export ITERM_PROFILE=$ITERM_PROFILE" \
        " export PROJECT_WINDOW_NUM=$PROJECT_WINDOW_NUM" \
        " setupHistory"\
        " clear"\
        )
else
    precommands=()
fi

arr2=()
if ! [ -t 0 ]; then
    while IFS=$'\n' read -r line_data; do
        arr2+=("${line_data}")
    done;
fi
combined=("${precommands[@]}" "${arr2[@]}")
arr=()
for e in "${combined[@]}"
do
    arr=("${e}" "${arr[@]}")
done

printf -v ARGS "write text \"%s\" & " "${arr[@]}"
ARGS=${ARGS% & }


TARGET_PROFILE="${ITERM_PROFILE:-Default}"
if ! osascript >/dev/null 2>&1 <<EOF
    tell application "iTerm"
        tell current window
            create tab with profile "$TARGET_PROFILE"
            tell current session
                select
                $ARGS
            end tell
        end tell
    end tell
EOF
then
    # Fallback when custom profile does not exist in iTerm.
    osascript >/dev/null 2>&1 <<EOF
    tell application "iTerm"
        tell current window
            create tab with profile "Default"
            tell current session
                select
                $ARGS
            end tell
        end tell
    end tell
EOF
fi

